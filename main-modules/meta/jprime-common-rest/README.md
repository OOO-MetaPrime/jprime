# Описание

Модуль для REST работы с данными, на основе метаописания

## Настройки модуля

| Настройка     | Описание  | По умолчанию  | 
| ------------- | ------------------ |  ----------- |  
| jprime.query.queryTimeout | Время ожидания запроса  | - | 
| jprime.api.checkLimit | Проверка максимального количества (limit) в выборке | true | 
| jprime.api.maxLimit | Максимальное количество в выборке через api | 1000 | 
| jprime.api.addLinks | Признак добавления в ответ hateoas ссылок для ссылочных объектов  | false| 

## Формат данных в представлении JSON

### Время

```json
{
    "attrCode": "04:59:00"
}
```

### Дата


```json
{
    "attrCode": "2021-04-24"
}
```

### Дата + время

```json
{
    "attrCode": "2021-04-24T00:00:00.000+0300"
}
```

### Денежное

```json
{
    "attrCode": {
        "value": "12.12",
        "currencyCode": "RUR"
    }
}
```

### Простая дробь

```json
{
  "attrCode": {
    "positive": true,
    "integer": 2,
    "numerator": 1,
    "denominator": 2
  }
}
```

### Диапазон целочисленных(32 бита)

```json
{
  "attrCode": {
    "lower": 1,
    "upper": 10,
    "closeLower": true,
    "closeUpper": true
  }
}
```

| Свойство      | Описание                            | 
| ------------- | ----------------------------------- |  
| closeLower    | Признак включения нижнего значения, в нормализированном виде значение true |
| closeUpper    | Признак включения верхнего значения, в нормализированном виде значение true |

### Диапазон дат

```json
{
  "attrCode": {
    "lower": "2021-04-24",
    "upper": "2021-04-30",
    "closeLower": true,
    "closeUpper": true
  }
}
```

| Свойство      | Описание                            | 
| ------------- | ----------------------------------- |  
| closeLower    | Признак включения нижнего значения, в нормализированном виде значение true |
| closeUpper    | Признак включения верхнего значения, в нормализированном виде значение true |

### Диапазон дат со временем

```json
{
  "attrCode": {
    "lower": "2021-04-24T00:00:00.000+0300",
    "upper": "2021-04-30T00:00:00.000+0300",
    "closeLower": true,
    "closeUpper": true
  }
}
```

| Свойство      | Описание                            | 
| ------------- | ----------------------------------- |  
| closeLower    | Признак включения нижнего значения  |
| closeUpper    | Признак включения верхнего значения |

### Строка

```json
{
  "attrCode": "216504, Смоленская обл, д.9, пер 3-й Ленина"
}
```

### Целочисленное

```json
{
    "attrCode": 191186
}
```

## Создание объекта (JSON)

``POST /api/v1/<множественный код метакласса>``

* формат запроса

```json
{
    "classCode": "spbCompany",
    "data": {
    	 ...
    }
}
```

* формат ответа:

```json
{
    "id": "1",
    "classCode": "spbCompany",
    "data": {
    	 ...
    }
}
```

## Обновление объекта (JSON)

``PUT /api/v1/<множественный код метакласса>``

* формат запроса

```json
{
    "id": "1",
    "classCode": "spbCompany",
    "data": {
    	 ...
    }
}
```

* формат ответа:

```json
{
    "id": "1",
    "classCode": "spbCompany",
    "data": {
    	 ...
    }
}
```

## Удаление объекта

``DELETE /api/v1/<множественный код метакласса>/<идентификатор объекта>``

## Создание объекта с файлом (через multipart form-data)

``POST /api/v1/<множественный код метакласса>``

* формат запроса

| Свойство     | Описание  | 
| ------------- | ------------------ |  
| body | Настройки создания в json  | 
| attr1 | Файл для атрибута attr1 (тип атрибута = файл) | 
| attr2 | Файл для атрибута attr2 (тип атрибута = файл) | 

* формат ответа:

```json
{
    "id": "1",
    "classCode": "spbCompany",
    "data": {
    	 ...
    }
}
```

## Обновление объекта с файлом (через multipart form-data)

``PUT /api/v1/<множественный код метакласса>``

* формат запроса

* формат запроса

| Свойство     | Описание  | Content Type |
| ------------- | ------------------ |  ------------------ | 
| body | Настройки обновления в json  | application/json;charset=UTF-8 |
| attr1 | Файл для атрибута attr1 (тип атрибута = файл) | |
| attr2 | Файл для атрибута attr2 (тип атрибута = файл) | |

* формат ответа:

```json
{
    "id": "1",
    "classCode": "spbCompany",
    "data": {
    	 ...
    }
}
```

## Скачивание файла из файлового атрибута
                    
``GET /api/v1/{code}/{objectId}/file/{attrCode}/{bearer>}``

| Свойство     | Описание  | 
| ------------- | ------------------ |  
| code | код метакласса  | 
| objectId | идентификатор объекта | 
| attrCode | кодовое имя атрибута типа файл |
| bearer | токен авторизации | 

## Скачивание архив файлов из файлового атрибута по обратным ссылкам
                    
``GET /api/v1/{code}/search/file/{attrCode}/{linkCode}/{linkValue}/{bearer}``

| Свойство     | Описание  | 
| ------------- | ------------------ |  
| code | код метакласса  | 
| attrCode | кодовое имя атрибута типа файл |
| linkCode | кодовое имя атрибута, по которому строится обратная ссылка |
| linkValue | значения атрибута, по котрому строится обратная ссылка |
| bearer | токен авторизации | 

## Блок поиска

### Критерии поиска

| Свойство     | Описание  | backReference | biginteger | boolean | date | datetime | double | float | integer | long | string | timestamp | time | uuid | range |
| ------------- | ------------------ |  ------------- |  ------------- |  ------------- |  ------------- |  ------------- |  ------------- |  ------------- |    ------------- |  ------------- |  ------------- |  ------------- | ------------- | ------------- | ------------- |
| isNull | Значение не указано | - | + | + | + | + | + | + | + | + | + | + | + | + | + |
| isNotNull | Значение указано | - | + | + | + | + | + | + | + | + | + | + | + | + | + |
| eq | Значение равно указанному | - | + | + | + | + | + | + | + | + | + | + | + | + | + |
| neq | Значение не равно указанному | - | + | + | + | + | + | + | + | + | + | + | + | + | + |
| gt | Значение больше указанного | - | + | - | - | - | + | + | + | + | - | - | - | - | + |
| gte | Значение больше или равно указанному | - | + | - | - | - | + | + | + | + | - | - | - | - | + |
| lt | Значение меньше указанному | - | + | - | - | - | + | + | + | + | - | - | - | - | + |
| lte | Значение меньше или равно указанному | - | + | - | - | - | + | + | + | + | - | - | - | - | + |
| eqYear | Значение равно указанному году | - | - | - | + | + | - | - | - | - | - | + | - | - | - |
| neqYear | Значение не равно указанному году  | - | - | - | + | + | - | - | - | - | - | + | - | - | - |
| gtYear | Значение больше указанного года  | - | - | - | + | + | - | - | - | - | - | + | - | - | - |
| gteYear | Значение больше или равно указанному года | - | - | - | + | + | - | - | - | - | - | + | - | - | - |
| ltYear | Значение меньше указанного года | - | - | - | + | + | - | - | - | - | - | + | - | - | - |
| lteYear | Значение меньше или равно указанного года | - | - | - | + | + | - | - | - | - | - | + | - | - | - |
| eqMonth | Значение равно указанному месяцу  | - | - | - | + | + | - | - | - | - | - | + | - | - | - |
| neqMonth | Значение не равно указанному месяцу  | - | - | - | + | + | - | - | - | - | - | + | - | - | - |
| gtMonth | Значение больше указанного месяца  | - | - | - | + | + | - | - | - | - | - | + | - | - | - |
| gteMonth | Значение больше или равно указанному месяца  | - | - | - | + | + | - | - | - | - | - | + | - | - | - |
| ltMonth | Значение меньше указанного месяца  | - | - | - | + | + | - | - | - | - | - | + | - | - | - |
| lteMonth | Значение меньше или равно указанного месяца  | - | - | - | + | + | - | - | - | - | - | + | - | - | - |
| eqDay | Значение равно указанному дню | - | - | - | + | + | - | - | - | - | - | + | - | - | - |
| neqDay | Значение не равно указанному дню  | - | - | - | + | + | - | - | - | - | - | + | - | - | - |
| gtDay | Значение больше указанного дня  | - | - | - | + | + | - | - | - | - | - | + | - | - | - |
| gteDay | Значение больше или равно указанному дню  | - | - | - | + | + | - | - | - | - | - | + | - | - | - |
| ltDay | Значение меньше указанного дня  | - | - | - | + | + | - | - | - | - | - | + | - | - | - |
| lteDay | Значение меньше или равно указанного дню  | - | - | - | + | + | - | - | - | - | - | + | - | - | - |
| between | Значение находится в указанном диапазоне | - | + | - | - | - | + | + | + | + | - | - | - | - | - |
| exists | Ссылочный атрибут содержит объекты по указанному условию | + | - | - | - | - | - | - | - | - | - | - | - | - | - |
| notExists | Ссылочный атрибут не содержит объекты по указанному условию | + | - | - | - | - | - | - | - | - | - | - | - | - | - |
| like | Значение содержит указанное | - | - | - | - | - | - | - | - | - | + | - | - | - | - |
| fuzzyLike | Нечеткий поиск | - | - | - | - | - | - | - | - | - | + | - | - | - | - |
| fuzzyOrderLike | Нечеткий поиск с учетом порядка слов | - | - | - | - | - | - | - | - | - | + | - | - | - | - |
| startsWith | Начинается с указанного | - | - | - | - | - | - | - | - | - | + | - | - | - | - |
| notStartsWith | Не начинается с указанного | - | - | - | - | - | - | - | - | - | + | - | - | - | - |
| in | Значение находится в указанном списке | - | + | + | + | + | + | + | + | + | + | + | + | + | - | 
| containsRange | Значение(диапазон) содержит указанный диапазон | - | - | - | - | - | - | - | - | - | - | - | - | - | + |
| containsEl | Значение(диапазон) содержит указанный элемент | - | - | - | - | - | - | - | - | - | - | - | - | - | + |
| overlapsRange | Значение(диапазон) содержится в указанном диапазоне | - | - | - | - | - | - | - | - | - | - | - | - | - | + |
| eqRange | Значение равно указаному диапазону | - | - | - | - | - | - | - | - | - | - | - | - | - | + |
| neqRange | Значение не равно указаному диапазону | - | - | - | - | - | - | - | - | - | - | - | - | - | + |
| gtRange | Значение больше указанного диапазона | - | - | - | - | - | - | - | - | - | - | - | - | - | + |
| gteRange | Значение больше или равно указанному диапазону | - | - | - | - | - | - | - | - | - | - | - | - | - | + |
| ltRange | Значение меньше указанного диапазона | - | - | - | - | - | - | - | - | - | - | - | - | - | + |
| lteRange | Значение больше или равно указанному диапазону | - | - | - | - | - | - | - | - | - | - | - | - | - | + |

Дополнительно, для ссылочных атрибутов со свойствами `refJPClass`+`refJPAttr` так же можно использовать для поиска по
ссылочным объектам: `exists` и `notExists`

Значения поиска для `virtualReference` соответствуют конечному типу данных, указанному в 'virtualType'

* fuzzyLike - нечеткий поиск. Для работоспособности в ``map`` должно быть указано поле ``fuzzy``, содержащее токены для
  нечеткого поиска
* fuzzyOrderLike - нечеткий поиск c учетом последовательности. Для работоспособности в ``map`` должно быть указано
  поле ``fuzzy``, содержащее токены для нечеткого поиска

## Получение списка объектов

``GET /api/v1/<множественный код метакласса>?offset=<>&limit=<>``

* ответ

```json
{
    "offset": 0,
    "limit": 10,
    "objectsCount": 1,
    "classCode": "spbCompany",
    "objects": [
        {
            "id": 1800065421,
            "classCode": "spbCompany",
            "title": null,
            "data": {
                "ownerType": 0,
                "dateReg": "2012-04-09T20:00:00.000+0000",
                "educationType": null,
                "municipality": null,
            }
        }
     ]
}
```

## Поиск

* общий формат 

``POST /api/v1/<множественный код метакласса>/search``

* формат с предзаполенным условием

``POST /api/v1/<множественный код метакласса>/search/<код атрибута>/<значение>``


### Форматы запроса

* название содержит

```json
{
       "offset": 0,
       "limit": 50,
       "filter": {
          "cond": {
               "attr": "longName",
               "like": "МАЯК"
             }
       }
} 
```

* название пустое
```json
{
       "offset": 0,
       "limit": 50,
       "filter": {
          "cond": {
               "attr": "longName",
               "isNull": true
             }
       }
} 
```

* название не пустое

```json
{
       "offset": 0,
       "limit": 50,
       "filter": {
          "cond": {
               "attr": "longName",
               "isNotNull": true
             }
       }
} 
```

* Выбор организации, у которой есть адрес, название которого содержит "Девяткино" + подсчет точного кол-во таких объектов 

```json
 {
       "offset": 0,
       "limit": 50,
       "totalCount": true,
       "filter": {
          "and": [ 
             { "cond": {
                 "attr": "addresses",
                 "exists": {
                               "cond":{"attr": "fullAddress","like": "Девяткино"}
                         }
               }
               }
             ]
       }
    
} 
```

* название начинается ИЛИ инн = с сортировкой по указанным атрибутам

```json
 {
    "limit": "10",
    "offset": "0",
    "filter": {"or": [
        {"cond": {"attr":"longName", "startsWith": "ООО"}},
        {"cond": {"attr":"inn", "eq": "7802199633"}}
        ]},
    "orders": [{"asc":"inn"}, {"desc":"longName"}]
} 
```

* объекты, удовлетворяющие указанному условию на указанную дату

```json
{
       "offset": 0,
       "limit": 50,
       "filter": {
          "cond": {
               "feature": "pers_date_n_lt",
               "checkDay": "2019-02-01"
             }
       }
} 
```

### Использование параметров авторизации в системе

В различных частях системы, например, блоке filter в search-запросах, возможно использование данных текущей авторизации

| Свойство     | Описание  |
| ------------- | ------------------ | 
| AUTH_USERID | Идентификатор пользователя |
| AUTH_ORGID | Организация пользователя |
| AUTH_DEPID | Подразделение пользователя |

Пример:

```json
{
    "totalCount": true,
    "offset": 0,
    "limit": 50,
    "filter": {
        "and": [
            {
                "cond": {
                    "attr": "org",
                    "eq": "{AUTH_ORGID}"
                }
            }
        ]
    }
}
```

### Формат ответов

```json
{
    "offset": 0,
    "limit": 10,
    "objectsCount": 1,
    "classCode": "spbCompany",
    "objects": [
        {
            "id": 1800065421,
            "classCode": "spbCompany",
            "title": null,
            "data": {
                "ownerType": 0,
                "dateReg": "2012-04-09T20:00:00.000+0000",
                "educationType": null,
                "municipality": null,
            }
        }
     ]
}
```

## Расчет доступа на момент запроса списка

При необходимости вместе со списком объектов можно получить настройки доступа к каждому объекту.
Для этого при запросе необходмо использовать опцию `access`

```json
 {
    "limit": "10",
    "offset": "0",
    "access": true
} 
```  
, в таком случае в ответ будет добавлена секция `access`:

```json
{
    "offset": 0,
    "limit": 10,
    "objectsCount": 10,
    "classCode": "test",
    "pluralCode": "tests",
    "objects": [
        {
            "id": 1,
            "classCode": "test",
            "data": {               
                "id": 1
            },
            "access": {
                "update": true,
                "delete": true
            }
        }
    ]
} 
```  

| Свойство     | Описание  |
| ------------- | ------------------ | 
| update | Права на изменение объекта |
| delete | Права на удаление объекта |


## Расчет значений агрегаций

``POST /api/v1/<множественный код метакласса>/aggregate``

Позволяет получить агрегационные значения для указанных атрибутов

### Возможные агрегации

| Агрегация     | Код  | Тип атрибута: string  | Тип атрибута: date   | Тип атрибута: datetime/timestamp   | Тип атрибута: time   |  Тип атрибута: int, long, double, biginteger   |
| ------------- | ------------------ | ------------------  | ------------------  | ------------------  | -----------------  |   -----------------  | 
| Максимум | MAX | +  | +  | +  | -  | +  |
| Минимум | MIN | +  | +  | +  | -  | +  |
| Среднее | AVG | -  |-  | -  | -  | +  |
| Сумма | SUM |  -  |-  | -  | -  | +  |
| Количество | COUNT | +  | +  | +  | +  | +  |
| Количество уникальных | COUNT_DISTINCT | +  | +  | +  | +  | +  |

### Формат запроса

```json
{
    "aggrs": [
        {
            "alias": "a1",
            "attr": "creationDate",
            "operator": "MAX"
        },
        {
            "alias": "a2",
            "attr": "creationDate",
            "operator": "MIN"
        }
    ],
    "filter": {
    	"cond": {
    		"attr": "creationDate", "gte": "2020-04-01T15:33:03.468+0300"
    	}
    }
}
```

| Свойство     | Описание  |
| ------------- | ------------------ | 
| aggrs | Набор агрегаций |
| alias | Псеводним агрегации, под которым будет отображен результат |
| attr | Кодовое имя атрибута, на который накладывается агрегация |
| operator | Код агрегации |
| filter | Ограничение выборки |


### Формат ответа

Ответ в `aggrs` является парой `alias` из первичного запроса - значение агрегации

```json
{
    "classCode": "spbCompany",
    "aggrs": {
        "a1": "2020-04-16T15:33:03.468+0300",
        "a2": "2020-04-02T12:15:00.000+0300"
    }
}
```

| Свойство     | Описание  |
| ------------- | ------------------ |
| classCode | Кодовое имя класса | 
| aggrs | Набор значений агрегаций |


## Значения по умолчанию

``POST /api/v1/<множественный код метакласса>/defvalue``

Позволяет получить значения по умолчанию перед созданием объекта 

### Формат запроса

```json
{
    "id": "1",
    "classCode": "spbCompany",
    "refAttrCode": "org",
    "data": {
    	 ...
    }
}
```

| Свойство     | Описание  |
| ------------- | ------------------ | 
| id | Идентификатор объекта, из которого создаем (может быть не указан) |
| classCode | Кодовое имя класса объекта, из которого создаем (может быть не указан)|
| data | Данные объекта, из которого создаем (может быть не указан) |
| refAttrCode | Атрибут текущего класса, по которому строилась ссылка (может быть не указан) |


### Формат ответа

```json
{
    "classCode": "spbDoc",
    "data": {
        "userOwnerId": "9999999912",
        "userEditorId": "9999999912",
        "citizenship": 643,
        "changeDate": "2020-04-23T18:25:23.240+0300",
        "creationDate": "2020-04-23T18:25:23.240+0300",
        "status": 1
    }
}
```

| Свойство     | Описание  |
| ------------- | ------------------ |
| classCode | Кодовое имя класса | 
| data | Значения по умолчанию для атрибутов |

## Дополнительная информация по объекту

``POST /api/v1/<множественный код метакласса>/addinfo``

Позволяет получить текстовое описание об объекте

### Формат запроса

```json
{
    "id": "10"
}
```

| Свойство     | Описание  |
| ------------- | ------------------ | 
| id | Идентификатор объекта |


### Формат ответа

```json
[
    {
        "code": "test1",
        "info": "Данные корректны"
    },
    ...
]
```

| Свойство     | Описание  |
| ------------- | ------------------ |
| code | Код сообщения | 
| info | Текст сообщения |